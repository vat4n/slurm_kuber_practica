## Deploy

В этой части добавляем последний шаг - деплой приложения в кластер k8s. Деплой производится с использованием утилиты helm. 

**1. Подготавливаем ci/cd**

Для этого скопируем `.gitlab-ci.yml` в проект `xpaste`, выполнив команду:

```bash
cp ~/slurm/practice/10.ci-cd/4.deploy/4.2.deploy/.gitlab-ci.yml ~/xpaste/
```

**2. Задаем IP kubeapi**

В файл `.gitlab-ci.yml` необходимо прописать IP адрес своего kubeapi. Для того, чтобы его получить, выполните команду:

```bash
kubectl cluster-info
```
Результат должен быть примерно следующим:
```bash
Kubernetes master is running at https://172.18.159.2:6443
KubeDNS is running at https://172.18.159.2:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
```
Теперь значение `Kubernetes master is running at` надо добавить в `.gitlab-ci.yml` для этого откроем его на редактирование:

```bash
vi ~/xpaste/.gitlab-ci.yml
```

И заменим строки:
```diff
variables:
-  K8S_API_URL: https://172.<xx>.<yyy>.2:6443
+  K8S_API_URL: https://172.18.159.2:6443
```

``Заменить надо на IP из предыдущей команды, а не на тот, который указан в README.md``

**3. Настройка ingress**

Доступ к приложению будет осуществляться через ingress. Ingress устанавливается вместе с приложением, но для его корректной работы необходимо прописать ему адрес. 
Для этого откроем values.yaml:
```bash
vi ~/xpaste/.helm/values.yaml
```

В конце файла необходимо заменить строку `<Ваш номер логина> - меняем на свой номер студента!!`:
```diff
- host: xpaste.s<Ваш номер логина>.edu.slurm.io
+ host: xpaste.s000001.edu.slurm.io
```

Сохраняем все изменения и пушим их в gitlab. Для этого необходимо выполнить команды:
```bash
cd ~/xpaste
git add .
git commit -am "Add deploy stage."
git push
```

**4. Проверка результата**

Для проверки результата необходимо перейти в gitlab в раздел `ci/cd -> pipelines` форка проекта xpaste. 
Можно воспользоваться прямой ссылкой: `https://gitlab.slurm.io/sXXXXXX/xpaste/pipelines`. `sXXXXXX` необходимо заменить на номер своего студента.

В результате все job должны закончиться без ошибок.

**5.Открываем приложение в браузере**

В браузере открываем url: xpaste.s<Ваш номер логина>.edu.slurm.io. `<Ваш номер логина>` необходимо заменить на номер своего студента. Открывать нужно в режиме `инкогнито`.

Если вы увидели `502` ошибку, значит практику выполнили верно.

**6. Самостоятельная работа**

Самостоятельная работа продолжительностью 5 минут. Во время самостоятельной работы надо попробовать ответить на вопрос:
  * Почему деплой закончился успешно, а приложение недоступно.

Ошибку пока исправлять не надо.

**7. Доработка ci/cd**

  * Для корректировки поведения ci/cd в шаге 5 необходимо внести изменения в ci/cd, описанные в [snippet](https://gitlab.slurm.io/snippets/60)
  * Для исправления ошибки в работе приложения необходимо внести изменения в chart, описанные в [snippet](https://gitlab.slurm.io/snippets/61)

Для проверки открываем в браузере url: `xpaste.s<Ваш номер логина>.edu.slurm.io`. `<Ваш номер логина>` необходимо заменить на номер своего студента. Открывать нужно в режиме `инкогнито`. Теперь приложение должно быть доступно.

* Бонус описание в [snippet](https://gitlab.slurm.io/snippets/62)

**8. Домашнее задание**

* Добавить в ci/cd stage, в котором будет выполняться rollback. Запуск stage должен осуществляться в ручном режиме.
* Добавить stage для запуска lint тестов для helm и dockerfile. Stage должен запускаться перед build.

Для lint тестов dockerfile можно воспользоваться [образом](https://github.com/hadolint/hadolint).

Один из вариантов реализации будет доступен спустя несколько часов после лекции в [snippet](https://gitlab.slurm.io/snippets/59)
